generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Order {
  id                    String        @id @default(cuid())
  modalityId            String
  tickets               Int
  status                String        @default("PENDING")
  termsAccepted         Boolean       @default(false)

  // valores em centavos
  totalAmount           Int?          // valor líquido (sem taxa)
  ticketsAmount         Int?          // só ingressos
  extrasAmount          Int?          // só extras
  feeAmount             Int?          // taxa da plataforma
  totalAmountWithFee    Int?          // valor cobrado do atleta (com taxa)

  // ✅ Cupom / desconto
  couponCode            String?
  discountAmount        Int?          // em centavos (valor descontado)
  discountedTotalAmount Int?          // total líquido após desconto (antes da taxa)
  coupon                Coupon?       @relation(fields: [couponCode], references: [code])

  // ✅ Mercado Pago
  mpPreferenceId        String?  @unique
  mpPaymentId           String?
  mpPaymentStatus       String?

  confirmationEmailSentAt DateTime?

  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  stripeSessionId       String?       @unique
  stripePaymentIntentId String?
  participants          Participant[]
}

model Participant {
  id             String             @id @default(cuid())
  orderId        String
  fullName       String
  cpf            String
  birthDate      String
  phone          String
  email          String
  city           String?
  state          String?
  tshirtSize     String
  emergencyName  String?
  emergencyPhone String?
  healthInfo     String?
  order          Order              @relation(fields: [orderId], references: [id])
  extras         ParticipantExtra[]
  bibNumber Int?
  teamIndex Int? // só faz sentido pra "equipes" (e opcionalmente "duplas" se quiser)
}

model ParticipantExtra {
  id            String      @id @default(cuid())
  participantId String
  type          String
  size          String?
  quantity      Int
  participant   Participant @relation(fields: [participantId], references: [id])
}

model BibCounter {
  id         String   @id // ex: "kids", "diversao", "competicao", "duplas", "equipes"
  nextNumber Int
  updatedAt  DateTime @updatedAt
}


enum CouponType {
  PERCENT   // ex: 10%
  FIXED     // ex: R$ 20,00 (2000 centavos)
}

model Coupon {
  code        String     @id // ex: "NATAL10"
  type        CouponType
  amount      Int        // PERCENT: 10 (10%) | FIXED: 2000 (R$ 20,00)
  active      Boolean    @default(true)

  // janela de validade (opcional)
  startsAt    DateTime?
  expiresAt   DateTime?

  // limites (opcional)
  maxUses     Int?       // limite global
  usedCount   Int        @default(0)

  // regra opcional para evitar cupom em valores muito baixos
  minSubtotal Int?       // em centavos (antes do desconto)

  // opcional: restringir por modalidade
  modalityId  String?

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  orders      Order[]
}